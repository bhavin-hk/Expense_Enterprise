{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <div class="header-content">
        <h1>Bank Accounts</h1>
        <div class="header-actions" style="display: flex; gap: 10px;">
            <button onclick="openAddModal()" class="btn-primary">+ Add New Account</button>
            <button onclick="openEnterpriseModal()" class="btn-primary">+ Add Current Account</button>
        </div>
    </div>
</div>

<!-- Personal Savings Accounts -->
<div class="dashboard-section card">
    <div class="bank-grid">
        {% for bank in banks %}
        <div class="bank-card">
            <!-- Header -->
            <div class="bank-card-header">
                <div class="bank-identity">
                    <div class="bank-icon-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <div class="bank-title-group">
                        <h3>{{ bank.bank_name }}</h3>
                        <div class="bank-sublink" onclick='openEditModal({{ bank | tojson }})'>Edit Details</div>
                    </div>
                </div>

                <div class="card-actions">
                    <a href="{{ url_for('delete_bank', bank_id=bank.id) }}" class="btn-icon-only delete"
                        onclick="return confirm('Remove this bank account?')" title="Remove">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            stroke-width="2" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Body: Details -->
            <div class="bank-card-body">
                <div class="detail-item">
                    <span class="detail-label">Account Num</span>
                    <span class="detail-value">{{ bank.account_number }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">IFSC Code</span>
                    <span class="detail-value">{{ bank.ifsc_code }}</span>
                </div>
            </div>

            <!-- Footer: Balance -->
            <div class="bank-card-footer">
                <div class="balance-group">
                    <span class="balance-label">Opening Balance</span>
                    <span class="balance-amount">{{ "%.2f"|format(bank.opening_balance or 0) }}</span>
                </div>
                <div class="balance-group" style="text-align: right;">
                    <span class="balance-label">Current Balance</span>
                    <span class="balance-amount" style="color: var(--brand-start);">{{
                        "%.2f"|format(bank.current_balance) }}</span>
                </div>
            </div>
        </div>
        {% else %}
        <p>No bank accounts added yet.</p>
        {% endfor %}
    </div>
</div>

<!-- Business & Credit Accounts Section -->
<div class="dashboard-header" style="margin-top: 40px;">
    <div class="header-content">
        <h1>Business &amp; Credit Accounts</h1>
    </div>
</div>

<div class="dashboard-section card">
    <div class="bank-grid">
        {% if enterprise_banks %}
        {% for bank in enterprise_banks %}
        <div class="bank-card">
            <div class="bank-card-header">
                <div class="bank-identity">
                    <div class="bank-icon-placeholder" style="background: linear-gradient(135deg, #10b981, #8b5cf6);">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="bank-title-group">
                        <h3><strong style="font-weight: 700;">{{ bank.business_name }}</strong> - {{ bank.bank_name }}
                            {% if bank.account_type == 'Current' %}
                            <span
                                style="background: #10b981; color: white; border-radius: 4px; padding: 2px 8px; font-size: 0.65em; font-weight: 600; vertical-align: middle; margin-left: 5px;">CURRENT</span>
                            {% elif bank.account_type == 'CC/OD' %}
                            <span
                                style="background: #8b5cf6; color: white; border-radius: 4px; padding: 2px 8px; font-size: 0.65em; font-weight: 600; vertical-align: middle; margin-left: 5px;">CC/OD</span>
                            {% endif %}
                        </h3>
                        <div class="bank-sublink" onclick='openEditEnterpriseModal({{ bank | tojson }})'>Edit Details
                        </div>
                    </div>
                </div>

                <div class="card-actions">
                    <a href="{{ url_for('delete_enterprise_bank', bank_id=bank.id) }}" class="btn-icon-only delete"
                        onclick="return confirm('Remove this business account?')" title="Remove">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            stroke-width="2" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </a>
                </div>
            </div>

            <div class="bank-card-body">
                <div class="detail-item">
                    <span class="detail-label">Account Num</span>
                    <span class="detail-value">{{ bank.account_number }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">IFSC Code</span>
                    <span class="detail-value">{{ bank.ifsc_code }}</span>
                </div>
            </div>

            <div class="bank-card-footer">
                <div class="balance-group">
                    <span class="balance-label">Opening Balance</span>
                    <span class="balance-amount">{{ "%.2f"|format(bank.opening_balance or 0) }}</span>
                </div>
                <div class="balance-group" style="text-align: right;">
                    <span class="balance-label">Current Balance</span>
                    <span class="balance-amount" style="color: var(--brand-start);">{{
                        "%.2f"|format(bank.opening_balance or 0) }}</span>
                </div>
            </div>
            <button class="btn-primary" style="width: 100%; margin-top: 0.75rem;"
                onclick='openBusinessAuth({{ bank | tojson }})'>Manage Business →</button>
        </div>
        {% endfor %}
        {% else %}
        <div
            style="width: 100%; grid-column: 1 / -1; padding: 40px; text-align: center; background: rgba(0,0,0,0.02); border: 1px dashed rgba(0,0,0,0.1); border-radius: 12px; opacity: 0.6; font-style: italic;">
            No business accounts linked yet.
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Personal Bank Modal -->
<div id="bank-modal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" class="close">&times;</span>
        <h2 id="modal-title">Add Bank Account</h2>
        <form id="bank-form" action="{{ url_for('add_bank') }}" method="POST">
            <div class="form-group">
                <label>Bank Name</label>
                <input type="text" id="bank_name" name="bank_name" placeholder="e.g. HDFC Bank" required>
            </div>
            <div class="form-group">
                <label>Account Number</label>
                <input type="number" id="account_number" name="account_number" placeholder="XXXX-XXXX-XXXX" required>
            </div>
            <div class="form-group">
                <label>IFSC Code</label>
                <input type="text" id="ifsc_code" name="ifsc_code" placeholder="HDFC0001234" required>
            </div>
            <div class="form-group">
                <label>Opening Balance</label>
                <input type="number" id="opening_balance" name="opening_balance" placeholder="0.00" step="0.01"
                    value="0">
            </div>
            <div class="modal-footer" style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" onclick="closeModal()" class="btn-secondary" style="flex: 1;">Cancel</button>
                <button type="submit" id="modal-submit-btn" class="btn-primary" style="flex: 2;">Add Account</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Enterprise Bank Modal (Separate — unique IDs) -->
<div id="enterprise-bank-modal" class="modal">
    <div class="modal-content">
        <span onclick="closeEnterpriseModal()" class="close">&times;</span>
        <h2 id="ent-modal-title">Add Business Account</h2>
        <form id="ent-bank-form" action="{{ url_for('add_enterprise_bank') }}" method="POST">
            <div class="form-group">
                <label>Business Name</label>
                <input type="text" id="ent_business_name" name="business_name" placeholder="e.g. My Agency" required>
            </div>
            <div class="form-group">
                <label>Account Type</label>
                <select id="ent_account_type" name="account_type" required>
                    <option value="Current">Current Account (Liquid)</option>
                    <option value="CC/OD">CC/OD Account (Credit/Overdraft)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bank Name</label>
                <input type="text" id="ent_bank_name" name="bank_name" placeholder="e.g. HDFC Business" required>
            </div>
            <div class="form-group">
                <label>Account Number</label>
                <input type="number" id="ent_account_number" name="account_number" placeholder="XXXX-XXXX-XXXX"
                    required>
            </div>
            <div class="form-group">
                <label>IFSC Code</label>
                <input type="text" id="ent_ifsc_code" name="ifsc_code" placeholder="HDFC0001234" required>
            </div>
            <div class="form-group">
                <label>Opening Balance</label>
                <input type="number" id="ent_opening_balance" name="opening_balance" placeholder="0.00" step="0.01"
                    value="0.00">
            </div>
            <div class="modal-footer" style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" onclick="closeEnterpriseModal()" class="btn-secondary"
                    style="flex: 1;">Cancel</button>
                <button type="submit" id="ent-modal-submit-btn" class="btn-primary" style="flex: 2;">Add Business
                    Account</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- Personal Bank Modal ---
    const modal = document.getElementById('bank-modal');
    const form = document.getElementById('bank-form');
    const title = document.getElementById('modal-title');
    const submitBtn = document.getElementById('modal-submit-btn');

    function openAddModal() {
        modal.style.display = "block";
        title.innerText = "Add Bank Account";
        submitBtn.innerText = "Add Account";
        form.action = "{{ url_for('add_bank') }}";
        form.reset();
        document.getElementById('opening_balance').value = "0";
    }

    function openEditModal(bank) {
        modal.style.display = "block";
        title.innerText = "Edit Bank Account";
        submitBtn.innerText = "Update Account";
        form.action = "/edit_bank/" + bank.id;

        document.getElementById('bank_name').value = bank.bank_name;
        document.getElementById('account_number').value = bank.account_number;
        document.getElementById('ifsc_code').value = bank.ifsc_code;
        document.getElementById('opening_balance').value = bank.opening_balance || 0;
    }

    function closeModal() {
        modal.style.display = "none";
    }

    // --- Enterprise Bank Modal ---
    const entModal = document.getElementById('enterprise-bank-modal');
    const entForm = document.getElementById('ent-bank-form');
    const entTitle = document.getElementById('ent-modal-title');
    const entSubmitBtn = document.getElementById('ent-modal-submit-btn');

    function openEnterpriseModal() {
        entModal.style.display = "block";
        entTitle.innerText = "Add Business Account";
        entSubmitBtn.innerText = "Add Business Account";
        entForm.action = "{{ url_for('add_enterprise_bank') }}";
        entForm.reset();
        document.getElementById('ent_business_name').value = "";
        document.getElementById('ent_opening_balance').value = "0";
    }

    function openEditEnterpriseModal(bank) {
        entModal.style.display = "block";
        entTitle.innerText = "Edit Business Account";
        entSubmitBtn.innerText = "Update Business Account";
        entForm.action = "/edit_enterprise_bank/" + bank.id;

        document.getElementById('ent_business_name').value = bank.business_name || "";
        document.getElementById('ent_bank_name').value = bank.bank_name;
        document.getElementById('ent_account_number').value = bank.account_number;
        document.getElementById('ent_ifsc_code').value = bank.ifsc_code;
        document.getElementById('ent_opening_balance').value = bank.opening_balance || 0;
        document.getElementById('ent_account_type').value = bank.account_type || "Current";
    }

    function closeEnterpriseModal() {
        entModal.style.display = "none";
    }

    // Close on outside click
    window.onclick = function (event) {
        if (event.target === modal) closeModal();
        if (event.target === entModal) closeEnterpriseModal();
        const authModal = document.getElementById('business-auth-modal');
        if (event.target === authModal) closeBusinessAuth();
    }
</script>

<!-- Business Auth Modal -->
<div id="business-auth-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeBusinessAuth()">&times;</span>
        <h2 id="biz-auth-title">Business Access</h2>
        <p id="biz-auth-subtitle" style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;"></p>

        <!-- Sign Up Form -->
        <form id="biz-signup-form" method="POST" action="{{ url_for('enterprise.enterprise_signup') }}"
            style="display:none;">
            <input type="hidden" id="signup_biz_name" name="business_name">
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" placeholder="business@example.com" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" placeholder="Create a password" required>
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" name="confirm_password" placeholder="Confirm password" required>
            </div>
            <div class="modal-footer" style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" onclick="closeBusinessAuth()" class="btn-secondary"
                    style="flex: 1;">Cancel</button>
                <button type="submit" class="btn-primary" style="flex: 2;">Sign Up</button>
            </div>
        </form>

        <!-- Sign In Form -->
        <form id="biz-signin-form" method="POST" action="{{ url_for('enterprise.enterprise_login') }}"
            style="display:none;">
            <input type="hidden" id="signin_biz_name" name="business_name">
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" placeholder="business@example.com" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" placeholder="Your password" required>
            </div>
            <div class="modal-footer" style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" onclick="closeBusinessAuth()" class="btn-secondary"
                    style="flex: 1;">Cancel</button>
                <button type="submit" class="btn-primary" style="flex: 2;">Sign In</button>
            </div>
        </form>

        <div id="biz-auth-loading" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            Checking registration status...
        </div>
    </div>
</div>

<script>
    function openBusinessAuth(bank) {
        const modal = document.getElementById('business-auth-modal');
        const signupForm = document.getElementById('biz-signup-form');
        const signinForm = document.getElementById('biz-signin-form');
        const loading = document.getElementById('biz-auth-loading');
        const title = document.getElementById('biz-auth-title');
        const subtitle = document.getElementById('biz-auth-subtitle');

        // Reset state
        signupForm.style.display = 'none';
        signinForm.style.display = 'none';
        loading.style.display = 'block';
        modal.style.display = 'block';
        title.innerText = bank.business_name;
        subtitle.innerText = 'Checking registration status...';

        // Set hidden fields
        document.getElementById('signup_biz_name').value = bank.business_name;
        document.getElementById('signin_biz_name').value = bank.business_name;

        // Check if registered
        fetch('/enterprise/check_auth/' + encodeURIComponent(bank.business_name))
            .then(r => r.json())
            .then(data => {
                loading.style.display = 'none';
                if (data.registered) {
                    signinForm.style.display = 'block';
                    subtitle.innerText = 'Sign in to manage this business.';
                } else {
                    signupForm.style.display = 'block';
                    subtitle.innerText = 'Create credentials to access enterprise features.';
                }
            })
            .catch(() => {
                loading.style.display = 'none';
                subtitle.innerText = 'Error checking status. Try again.';
            });
    }

    function closeBusinessAuth() {
        document.getElementById('business-auth-modal').style.display = 'none';
    }
</script>
{% endblock %}