{% extends "enterprise/layout.html" %}

{% block enterprise_content %}
<style>
    .input-group {
        display: flex;
        gap: 0;
        width: 100%;
    }

    .input-group .input-select {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        flex: 1;
    }

    .input-group .btn-add-on {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        padding: 0 12px;
        background: var(--surface-secondary);
        border: 1px solid var(--border-color);
        border-left: none;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 1.2rem;
    }

    .input-group .btn-add-on:hover {
        background: var(--surface-tertiary);
        color: var(--accent-color);
    }

    /* Nested Modal Style - must be higher than base modal-overlay (2000) */
    .modal-overlay.nested {
        z-index: 2100;
    }
</style>
<div class="ent-cashflow">
    <!-- Header Metrics -->
    <div class="cashflow-metrics">
        <div class="metric-card income-focus">
            <div class="metric-label">Total Income</div>
            <div class="metric-value">{{ currency }}{{ "{:,.2f}".format(total_income) }}</div>
            <div class="metric-indicator">↑ Inflow</div>
        </div>
        <div class="metric-card expense-focus">
            <div class="metric-label">Total Expenses</div>
            <div class="metric-value">{{ currency }}{{ "{:,.2f}".format(total_expenses) }}</div>
            <div class="metric-indicator">↓ Outflow</div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="ent-toolbar">
        <form method="GET" class="filter-group">
            <select name="period" onchange="this.form.submit()" class="input-select">
                <option value="this_month" {{ 'selected' if period=='this_month' }}>This Month</option>
                <option value="last_month" {{ 'selected' if period=='last_month' }}>Last Month</option>
                <option value="this_year" {{ 'selected' if period=='this_year' }}>This Year</option>
                <option value="custom" {{ 'selected' if period=='custom' }}>Custom Range</option>
            </select>

            {% if period == 'custom' %}
            <input type="date" name="start_date" value="{{ start_date }}" class="input-date">
            <input type="date" name="end_date" value="{{ end_date }}" class="input-date">
            <button type="submit" class="btn-primary">Apply</button>
            {% endif %}
        </form>

        <button class="btn-primary" onclick="openModal('transactionModal')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Transaction
        </button>
    </div>

    <!-- Ledger Table -->
    <div class="ledger-wrapper">
        <table class="ledger-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Method</th>
                    <th>Taken By</th>
                    <th class="col-narrative">Narrative</th>
                    <th class="text-right">Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for item in ledger %}
                <tr class="{{ 'row-income' if item.type == 'Income' else 'row-expense' }}">
                    <td class="text-nowrap">{{ item.date }}</td>
                    <td>
                        <span class="type-badge {{ item.type.lower() }}">
                            {% if item.type == 'Income' %}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                            {% else %}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                                <polyline points="17 18 23 18 23 12"></polyline>
                            </svg>
                            {% endif %}
                            {{ item.type }}
                        </span>
                    </td>
                    <td>
                        <span class="method-tag">
                            {% if item.bank_name %}
                            Bank: {{ item.bank_name }}
                            {% else %}
                            {{ item.method }}
                            {% endif %}
                        </span>
                    </td>
                    <td class="text-nowrap">{{ item.taken_by_name or 'System' }}</td>
                    <td class="col-narrative">{{ item.narrative }}</td>
                    <td
                        class="text-right font-bold {{ 'status-positive' if item.type == 'Income' else 'status-negative' }}">
                        {{ currency }}{{ "{:,.2f}".format(item.amount) }}
                    </td>
                </tr>
                {% endfor %}
                {% if not ledger %}
                <tr>
                    <td colspan="6" class="text-center" style="padding: 3rem; color: var(--text-tertiary);">
                        No transactions found for this period.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Transaction Modal -->
<div id="transactionModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Record Transaction</h3>
            <button class="close-btn" onclick="closeModal('transactionModal')">&times;</button>
        </div>
        <form action="{{ url_for('enterprise.add_transaction') }}" method="POST" class="modal-form">
            <div class="form-group">
                <label>Transaction Type</label>
                <div class="segmented-control type-toggle">
                    <input type="radio" name="type" value="Income" id="type-income" checked>
                    <label for="type-income" class="label-income">Income</label>
                    <input type="radio" name="type" value="Expense" id="type-expense">
                    <label for="type-expense" class="label-expense">Expense</label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Amount ({{ currency }})</label>
                    <input type="number" name="amount" step="0.01" required placeholder="0.00" class="input-text">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" name="date" value="{{ today_date }}" required class="input-date">
                </div>
            </div>

            <div class="form-group" id="categoryGroup">
                <label>Category</label>
                <select name="category" class="input-select full-width">
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Taken By</label>
                <div class="input-group">
                    <select name="taken_by" id="takenBySelect" class="input-select">
                        {% for member in members %}
                        <option value="{{ member.id }}" {% if member.id==session['user'] %}selected{% endif %}>
                            {{ member.full_name }}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn-add-on" onclick="openModal('addMemberModal')"
                        title="Add New Person">+</button>
                </div>
            </div>

            <div class="form-group">
                <label>Payment Method</label>
                <select name="method" class="input-select full-width">
                    <option value="Cash">Cash</option>
                    {% if enterprise_banks %}
                    <optgroup label="Enterprise Accounts">
                        {% for bank in enterprise_banks %}
                        <option value="{{ bank.id }}">{{ bank.bank_name }} - {{ bank.account_type }}</option>
                        {% endfor %}
                    </optgroup>
                    {% endif %}
                </select>
            </div>

            <div class="form-group">
                <label>Narrative / Notes</label>
                <textarea name="narrative" rows="3" placeholder="Description of transaction..."
                    class="input-text"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
                <button type="submit" class="btn-primary">Save Transaction</button>
            </div>
        </form>
    </div>
</div>

<!-- Fast Add Member Modal -->
<div id="addMemberModal" class="modal-overlay nested">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Add New Person</h3>
            <button class="close-btn" onclick="closeModal('addMemberModal')">&times;</button>
        </div>
        <div class="modal-form">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="newMemberName" placeholder="e.g. John Doe" class="input-text full-width">
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="newMemberEmail" placeholder="e.g. john@example.com"
                    class="input-text full-width">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('addMemberModal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="submitFastAddMember()">Add Now</button>
            </div>
        </div>
    </div>
</div>

<script>
    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }
    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    async function submitFastAddMember() {
        const name = document.getElementById('newMemberName').value;
        const email = document.getElementById('newMemberEmail').value;

        if (!name || !email) {
            alert('Please fill both name and email');
            return;
        }

        try {
            const response = await fetch("{{ url_for('enterprise.add_member_fast') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ full_name: name, email: email })
            });

            const result = await response.json();
            if (result.success) {
                // Add to dropdown
                const select = document.getElementById('takenBySelect');
                const option = document.createElement('option');
                option.value = result.member.id;
                option.text = result.member.full_name;
                option.selected = true;
                select.add(option);

                // Clear and close
                document.getElementById('newMemberName').value = '';
                document.getElementById('newMemberEmail').value = '';
                closeModal('addMemberModal');
            } else {
                alert("Error: " + (result.error || "Unknown error"));
            }
        } catch (err) {
            console.error(err);
            alert("Failed to add member.");
        }
    }

    // Auto-set today's date if not passed
    window.onload = function () {
        const dateInput = document.querySelector('input[type="date"][name="date"]');
        if (dateInput && !dateInput.value) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    }
</script>
{% endblock %}